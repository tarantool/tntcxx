PROJECT(tntcxx)

CMAKE_MINIMUM_REQUIRED(VERSION 3.5)

IF(NOT CMAKE_BUILD_TYPE)
    SET(CMAKE_BUILD_TYPE Debug)
ENDIF()

MESSAGE(STATUS "Build type: ${CMAKE_BUILD_TYPE}")
FIND_PACKAGE (benchmark QUIET)

SET(COMMON_LIB ev)

# OpenSSL
IF (TNTCXX_ENABLE_SSL)
FIND_PACKAGE(OpenSSL)
IF (OPENSSL_FOUND)
    MESSAGE(STATUS "OpenSSL ${OPENSSL_VERSION} found")
    INCLUDE_DIRECTORIES(${OPENSSL_INCLUDE_DIR})
ELSE()
    MESSAGE(FATAL_ERROR "Could NOT find OpenSSL development files (libssl-dev/openssl-devel package)")
ENDIF()

# OpenSSL can require Z library (depending on build time options), so we add
# it to libraries list in case of static openssl linking.
IF(OPENSSL_USE_STATIC_LIBS)
    SET(OPENSSL_LIBRARIES ${OPENSSL_LIBRARIES} ${ZLIB_LIBRARIES})
ENDIF()

SET(COMMON_LIB ${COMMON_LIB} ${OPENSSL_LIBRARIES})

ENDIF() # IF (TNTCXX_ENABLE_SSL)

SET(CMAKE_CXX_STANDARD 17)
SET(CMAKE_C_STANDARD 11)
ADD_COMPILE_OPTIONS(-Wall -Wextra -Werror)
CONFIGURE_FILE(./test/cfg.lua test_cfg.lua COPYONLY)
CONFIGURE_FILE(./test/cfg_ssl.lua test_cfg_ssl.lua COPYONLY)
CONFIGURE_FILE(./test/gen_ssl.sh test_gen_ssl.sh COPYONLY)

INCLUDE_DIRECTORIES(.)
INCLUDE_DIRECTORIES(./src)
INCLUDE_DIRECTORIES(./third_party/libev)
ADD_LIBRARY(ev STATIC third_party/libev/ev.c)
TARGET_COMPILE_DEFINITIONS(ev PRIVATE EV_STANDALONE=1)
TARGET_COMPILE_OPTIONS(ev PRIVATE -w)
ADD_EXECUTABLE(MempoolUnitTest.test src/Utils/Mempool.hpp test/MempoolUnitTest.cpp)
ADD_EXECUTABLE(CStrUnit.test src/Utils/CStr.hpp test/CStrUnitTest.cpp)
ADD_EXECUTABLE(CommonUnit.test src/Utils/Common.hpp test/CommonUnitTest.cpp)
ADD_EXECUTABLE(TraitsUnit.test src/Utils/Traits.hpp test/TraitsUnitTest.cpp)
ADD_EXECUTABLE(RefVectorUnit.test src/Utils/RefVector.hpp test/RefVectorUnitTest.cpp)
ADD_EXECUTABLE(ItrRangeUnit.test src/Utils/ItrRange.hpp test/ItrRangeUnitTest.cpp)
ADD_EXECUTABLE(Base64Unit.test src/Utils/Base64.hpp test/Base64UnitTest.cpp)
ADD_EXECUTABLE(BufferUnit.test src/Buffer/Buffer.hpp test/BufferUnitTest.cpp)
ADD_EXECUTABLE(BufferPerf.test src/Buffer/Buffer.hpp test/BufferPerfTest.cpp)
ADD_EXECUTABLE(RingUnit.test src/Utils/Ring.hpp test/RingUnitTest.cpp)
ADD_EXECUTABLE(ListUnit.test src/Utils/List.hpp test/ListUnitTest.cpp)
ADD_EXECUTABLE(RulesUnit.test src/mpp/Rules.hpp test/RulesUnitTest.cpp)
ADD_EXECUTABLE(EncDecUnit.test src/mpp/mpp.hpp test/EncDecTest.cpp)
ADD_EXECUTABLE(Client.test src/Client/Connector.hpp test/ClientTest.cpp)
ADD_EXECUTABLE(ClientPerfTest.test src/Client/Connector.hpp test/ClientPerfTest.cpp)
ADD_EXECUTABLE(SimpleExample examples/Simple.cpp)
TARGET_LINK_LIBRARIES(SimpleExample ${COMMON_LIB})
TARGET_LINK_LIBRARIES(ClientPerfTest.test ${COMMON_LIB})
TARGET_LINK_LIBRARIES(Client.test ${COMMON_LIB})
IF (TNTCXX_ENABLE_SSL)
    ADD_EXECUTABLE(ClientSSL.test src/Client/Connector.hpp test/ClientTest.cpp)
    TARGET_LINK_LIBRARIES(ClientSSL.test ${COMMON_LIB})
    TARGET_COMPILE_DEFINITIONS(ClientSSL.test PUBLIC TNTCXX_ENABLE_SSL)
ENDIF()

IF (benchmark_FOUND)
    ADD_EXECUTABLE(BufferGPerf.test src/Buffer/Buffer.hpp test/BufferGPerfTest.cpp)
    TARGET_LINK_LIBRARIES (BufferGPerf.test benchmark::benchmark)
ENDIF()

ENABLE_TESTING()
ADD_TEST(NAME MempoolUnitTest.test COMMAND MempoolUnitTest.test)
ADD_TEST(NAME CStrUnit.test COMMAND CStrUnit.test)
ADD_TEST(NAME CommonUnit.test COMMAND CommonUnit.test)
ADD_TEST(NAME TraitsUnit.test COMMAND TraitsUnit.test)
ADD_TEST(NAME RefVectorUnit.test COMMAND RefVectorUnit.test)
ADD_TEST(NAME ItrRangeUnit.test COMMAND ItrRangeUnit.test)
ADD_TEST(NAME Base64Unit.test COMMAND Base64Unit.test)
ADD_TEST(NAME BufferUnit.test COMMAND BufferUnit.test)
ADD_TEST(NAME RingUnit.test COMMAND RingUnit.test)
ADD_TEST(NAME ListUnit.test COMMAND ListUnit.test)
ADD_TEST(NAME RulesUnit.test COMMAND RulesUnit.test)
ADD_TEST(NAME EncDecUnit.test COMMAND EncDecUnit.test)
ADD_TEST(NAME Client.test COMMAND Client.test)
IF (TNTCXX_ENABLE_SSL)
    ADD_TEST(NAME ClientSSL.test COMMAND ClientSSL.test)
ENDIF()
